# ctfcup-2022 | Stage2 | Great mettender

Разбор сервиса Great Mettender с полуфинала Кубка CTF России 2022.

## Описание

Сервис представляет из себя систему проведения тендеров с возможностью оставлять заявки на участие и
"исполнять" свои заявки, если они выиграли. Протокол взаимодействия с сервисом – gRPC over QUIC, что
затрудняет анализ трафика и повторение чужих эксплоитов.

Заявка на участие в тендере – программа на brainfuck в сжатом формате, а каждый тендер содержит приватную информацию
(флаги), которая при исполнении заявки подается на вход программе. Вывод программы показывается только автору тендера.

## Флаги

Проверяющая система кладёт флаг в поле входных данных тендера.

## Уязвимости

Сервис содержит одну уязвимость.

### 1. Переполнение стека вызовов в gzip.Reader

В коде сервиса не запланировано уязвимостей. Единственное место, где создающему заявку на тендер
можно было прочитать входные данные этого тендера -- обработчик непредвиденной ошибки в исполнении
кода на brainfuck, при этом код возврата 1 в исполнителе проверяется явно,
а остальные места с ошибками трудно достижимы.

Версия golang, используемая в сервисе -- 1.18.3, она достаточно свежая и не бросается в глаза.
Тем не менее, в ней есть проблема в реализации `gzip.Reader.Read()`
([source](https://github.com/golang/go/blob/go1.18.3/src/compress/gzip/gunzip.go#L286)) – реализация вызывает `.Read`
рекурсивно, пока не наберется полный буфер данных. Таким образом, если в качестве программы передать много gzip-чанков
длины 0 (эксплоит использует 4950000 чанков), стек вызовов интерпретатора переполнится при декодировании программы,
произойдет `panic`, который завершит программу с кодом 2,
[executor.go](../../services/great_mettender/internal/executor/executor.go) зайдет в ветку на 85 строке, вернет
ошибку, которая дополнится дебаг-информацией на строке 110
[сервиса bids](../../services/great_mettender/internal/bids/service.go) и вернет флаг.

Также необходимо было выиграть тендер, оставив заявку с минимальной суммой (min_float) и дождаться, пока
чекер завершит тендер. Пример полной реализации атаки вместе с ожиданием (но без min_float) можно увидеть в
[main.go](./main.go).

#### Исправление уязвимости

Для исправления достаточно обновить go до версии, не подверженной проблеме, например, 1.18.4. Обновление до
go 1.19 более сложное, поскольку требует также обновления библиотеки quic-go и исправления ошибок, возникших
из-за отсутствия обратной совместимости в этой чудной библиотеке.

Пример патча можно посмотреть [здесь](./cve.patch).

#### Unintended решение

Команда .einabe в течение CTF нашла unintended способ вызвать панику: на строке 80 файла
[cmd/interfuck/main.go](../../services/great_mettender/cmd/interfuck/main.go) пропущен handle ошибки,
поэтому, если передать некорректный brainfuck код, после компиляции program будет равно nil, и первая строка
`program.Run()` вызовет панику. Далее решение (включая победу в тендере) повторяет intended уязвимость.
