# ctfcup-2022 | Stage2 | Nucreport

Разбор сервиса Nucreport с полуфинала Кубка CTF России 2022.

## Описание

Сервис представляет собой систему для работы с файлами-отчетами о работе АЭС.

Функциональность сервиса позволяет пользователю загрузить файл по протоколу SFTP, а затем прочитать этот файл используя
web-интерфейс.

В сервисе реализован простой контроль доступа к файлам.

На уровне SFTP/Linux: директория каждого пользователя имеет права 755,
однако в SFTP клиенте выставлена umask, из-за которой
загруженные файлы будут иметь права доступа 600.

С точки зрения Web-приложения: владелец файла может прочитать любой файл,
находящийся в его директории или в поддиректории. Также любой пользователь может прочитать файл, если будет знать токен
доступа к этому файлу. Токен доступа к файлу знает только владелец этого файла.

## Флаги

Проверяющая система загружает файл как файл-отчет с названием 'flag.txt'.

## Уязвимости

Сервис содержит одну уязвимость.

### 1. Обход проверки прав доступа используя Symlink. 

Уязвимость возникает из-за недостаточно строгой реализации алгоритма индексирования файлов и проверки прав
доступа к ним внутри веб-приложения.

В приложении предусмотрен функционал 'индексации' файлов — рекурсивного обхода домашней директории пользователя
с целью найти загруженные по SFTP файлы и сгенерировать для них токены доступа. 


Рекурсивный обход использует стандартный класс [WalkDir](../../services/nucreport/app/src/service.rs#L173).
По-умолчанию данный класс [не проверяет символические ссылки](https://docs.rs/walkdir/latest/walkdir/struct.WalkDir.html#method.follow_links).
При этом у нас есть возможность создать символическую ссылку по протоколу SFTP.

В реализации чтения файла присутствует [нормализация пути](../../services/nucreport/app/src/service.rs#L108), которая 
проверяет символические ссылки и не позволит прочитать файл, однако нормализованный путь никак не используется 
при чтении файла с токеном доступа.

Алгоритм атаки: 
1. Создать пользователя, например 'hacker'.
2. По SFTP создать символическую ссылку внутри директории пользователя на файл, который мы хотим прочитать. 

    Например, `symlink hack.txt /users/victim/flag.txt`
3. Проиндексировать свою директорию, получить токен для чтения hack.txt.
4. Через веб-приложение прочитать hack.txt с токеном доступа. 
Например `http://localhost:8080/api/file?path=/users/attacker/hack.txt&token=example`

[Скрипт-пример эксплуатации.](symlink.py)

#### Исправление уязвимости.

Существует 2 простых способа исправления уязвимости: 
1. Во время индексации файлов (функция [index_dir](../../services/nucreport/app/src/service.rs#L170)) 
включить опцию [follow links](https://docs.rs/walkdir/latest/walkdir/struct.WalkDir.html#method.follow_links) и проверять что файл находится внутри директории пользователя.
2. Внутри функции [read_file](../../services/nucreport/app/src/service.rs#L98) при чтении файла по токену
использовать нормализованный путь. Тогда вместо пути до ссылки в функцию поиска подставится путь до оригинального файла,
токен к которому атакующий не знает. 

[Пример исправления.](symlink.patch)