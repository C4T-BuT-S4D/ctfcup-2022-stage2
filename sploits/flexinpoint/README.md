# ctfcup-2022 | Stage2 | Flexinpoint

Разбор сервиса Flexinpoint с полуфинала Кубка CTF России 2022.

## Описание

Сервис представляет из себя систему учета станций метро и нахождения кратчайшего маршрута между ними. Протокол взаимодействия с сервисом – flatbuffers + flexbuffers over gRPC, что
затрудняет анализ трафика и повторение чужих эксплоитов.

Поиск кратчайшего пути осуществляется алгоритмом Дейкстры по станциям, выбранным через задание атрибутов.

## Флаги

Проверяющая система кладёт флаг в поле _description атрибутов станции.

## Уязвимости

Сервис содержит одну уязвимость.

### 1. 0-byte инъекция в функцию escape библиотеки libpqxx

При нахождении пути между станциями результатом является длина кратчайшего пути между ними и конкатенация полей _description станций на этом пути. Единственное, что не позволяет получить флаг напрямую - отсутствие информации про атрибуты станции флагом - известно только ее _name (из attack_data), однако на такой атрибут стоит дополнительная проверка в [server.cpp](../../internal/flexinpoint/server/server.cpp#L307). Обойти данную проверку можно, передав в качестве аргумента "_name\x00". Проверка на равенство _name происходит в C++ типе string, который не игнорирует 0-byte и посчитает эти строки различными, однако при передаче ее в функцию escape библиотеки libpqxx, она доберется до реализации этой библиотеки на языке C, где благополучно обрежется по 0-byte в силу реализации строк в данном языке. Таким образом мы получаем возможность запросить станции с заданным именем. Осталось лишь построить кратчайший путь от нее до какой-нибудь другой станции и получить флаг.

Пример полной реализации атаки можно увидеть в
[main.cpp](../../internal/flexinpoint/exploit/main.cpp).

#### Исправление уязвимости.

Для исправления уязвимости достаточно сделать работу со строками в libpqxx и сравнение консистентными. Например сравнивать строки не с помощью operator==, а C-функцией strcmp, чтобы учесть 0-byte.

[Пример исправления.](null_byte_search.patch)
